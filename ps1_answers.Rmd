---
title: "Problem Set 1"
author: "Patrick Altmeyer, Helena Patterson, Daniel Mueck and Gabriela Lavagna"
date: "`r format(Sys.Date(), '%d %B, %Y')`"
output: 
  bookdown::pdf_document2:
    toc: false
  bookdown::html_document2:
    code_folding: show
    number_sections: false
    toc: true
    toc_float: true
bibliography: bib.bib
---

```{r setup, include=FALSE}
rm(list=ls())
knitr::opts_chunk$set(echo = FALSE, message=FALSE)
library(data.table)
```

```{r}
dt <- fread("data/ncr.txt")
```

# Question 1
# Average pass-through

## Bank and firm fixed effects

As a first step, we look to estimate an average pass-through of Monetary Policy shocks. We run two regressions with our dependent variables as interest rates and bank's credit volume, controlling for macroeconomic factors (GDP and inflation) and other specific bank-related factors. As we are only examining the average monetary policy pass-through at this stage, we do not include the time-related fixed effects. Instead, we include only a bank and firm fixed effect, which absorbs the time-varying heterogeneity at the firm and bank level. 

This first regression is shown in Table 1 below. Column 1 represents the dependent variable of the bank's credit volume and column 2 shows the regression results when considering the interest rate charged as the dependent variable. As we can see, when considering in terms of average pass-through, the monetary policy shock variable is statistically significant. Indeed, the results indicate that a rise in the base interest rate is associated with both a fall in credit volume and a rise in the interest rates charged by lenders, as would be expected. 

```{r, echo=TRUE}
library(lfe)
dep_vars <- c("lncredit", "intrate")
index_vars <- c("firmid", "bankid") # for entity fixed-effects
indep_vars <- colnames(dt)[!colnames(dt) %in% c(dep_vars, "date_q")]
output <- lapply(
  1:length(dep_vars),
  function(i) {
    col_names <- c(dep_vars[i], indep_vars)
    mod_data <- dt[,.SD,.SDcols=col_names]
    setnames(mod_data, dep_vars[i], "y")
    col_names <- colnames(mod_data)
    f <- paste("y ~", paste(col_names[!col_names %in% c("y", index_vars)], collapse = " + "))
    f <- as.formula(paste(f, paste(index_vars, collapse = " + "),sep = " | "))
    t0 <- Sys.time()
    message(sprintf("Fitting model for: %s", dep_vars[i]))
    mod <- felm(f, data = mod_data)
    message(sprintf("Converged after %0.2f seconds.", as.numeric(Sys.time()-t0)))
    return(mod)
  }
)
names(output) <- dep_vars
```

 
```{r tab1, results='asis'}
library(stargazer)
stargazer(output, header = F, dep.var.labels.include = T)
```
\FloatBarrier

In order to verify the robustness of our estimates, we next look to run these regressions with fewer controls. Specifically, we start by examining the regression just by taking into account the macroeconomic factors (GDP and inflation).  

```{r}
dep_vars <- c("lncredit", "intrate")
index_vars <- c("firmid", "bankid") # for entity fixed-effects
indep_vars <- colnames(dt)[!colnames(dt) %in% c(dep_vars, "date_q", "bdepo_l","bcet1_l","bsize_l","blar_l")]
output <- lapply(
  1:length(dep_vars),
  function(i) {
    col_names <- c(dep_vars[i], indep_vars)
    mod_data <- dt[,.SD,.SDcols=col_names]
    setnames(mod_data, dep_vars[i], "y")
    col_names <- colnames(mod_data)
    f <- paste("y ~", paste(col_names[!col_names %in% c("y", index_vars)], collapse = " + "))
    f <- as.formula(paste(f, paste(index_vars, collapse = " + "),sep = " | "))
    t0 <- Sys.time()
    message(sprintf("Fitting model for: %s", dep_vars[i]))
    mod <- felm(f, data = mod_data)
    message(sprintf("Converged after %0.2f seconds.", as.numeric(Sys.time()-t0)))
    return(mod)
  }
)
names(output) <- dep_vars
```

```{r tab1, results='asis'}
library(stargazer)
stargazer(output, header = F, dep.var.labels.include = T)
```
\FloatBarrier




## Firm and time fixed effects

```{r}
dep_vars <- c("lncredit", "intrate")
index_vars <- c("firmid") # for entity fixed-effects
interaction_terms_bank_level <- c("bdepo_l", "bcet1_l", "bsize_l", "blar_l")
interaction_term_names = sprintf("mp_x_%s", interaction_terms_bank_level)
dt[,(interaction_term_names):=lapply(.SD, function(i) i*mpshock_l),.SDcols=interaction_terms_bank_level]
indep_vars <- colnames(dt)[!colnames(dt) %in% c(dep_vars,"bankid","date_q")]
output <- lapply(
  1:length(dep_vars),
  function(i) {
    col_names <- c(dep_vars[i], indep_vars)
    mod_data <- dt[,.SD,.SDcols=col_names]
    setnames(mod_data, dep_vars[i], "y")
    col_names <- colnames(mod_data)
    f <- paste("y ~", paste(col_names[!col_names %in% c("y", index_vars)], collapse = " + "))
    f <- as.formula(paste(f, paste(index_vars, collapse = " + "),sep = " | "))
    t0 <- Sys.time()
    message(sprintf("Fitting model for: %s", dep_vars[i]))
    mod <- felm(f, data = mod_data)
    message(sprintf("Convered after %0.2f seconds.", as.numeric(Sys.time()-t0)))
    return(mod)
  }
)
names(output) <- dep_vars
```

```{r tab2, results='asis'}
library(stargazer)
stargazer(output, header = F, dep.var.labels.include = T)
```

## Controlling for scales

```{r standardized}
dt_stand <- copy(dt)
stand_var <- c("mpshock_l", interaction_terms_bank_level)
dt_stand[,(stand_var):=lapply(.SD, function(i) (i-mean(i,na.rm=T))/sd(i, na.rm = T)), .SDcols=stand_var]
dt_stand[,(interaction_term_names):=lapply(.SD, function(i) i*mpshock_l),.SDcols=interaction_terms_bank_level]
output <- lapply(
  1:length(dep_vars),
  function(i) {
    col_names <- c(dep_vars[i], indep_vars)
    mod_data <- dt_stand[,.SD,.SDcols=col_names]
    setnames(mod_data, dep_vars[i], "y")
    col_names <- colnames(mod_data)
    f <- paste("y ~", paste(col_names[!col_names %in% c("y", index_vars)], collapse = " + "))
    f <- as.formula(paste(f, paste(index_vars, collapse = " + "),sep = " | "))
    t0 <- Sys.time()
    message(sprintf("Fitting model for: %s", dep_vars[i]))
    mod <- felm(f, data = mod_data)
    message(sprintf("Convered after %0.2f seconds.", as.numeric(Sys.time()-t0)))
    return(mod)
  }
)
names(output) <- dep_vars
```

```{r tab3, results='asis'}
library(stargazer)
stargazer(output, header = F, dep.var.labels.include = T)
```

# Discussion
